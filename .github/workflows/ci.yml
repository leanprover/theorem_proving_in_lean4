name: mdbook test using latest lean4 bits

# Controls when the action will run.
on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  repository_dispatch:
    types: [build_event]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  Build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        # interferes with lean4-nightly authentication
        persist-credentials: false
        submodules: true
    # - uses: robinraju/release-downloader@v1.4
    #   with:
    #     latest: true
    #     fileName: lean-4.0.0-nightly-*-linux.tar.zst
    #     repository: leanprover/lean4-nightly
    - uses: houqp/download-release-assets@v1
      with:
          repo: leanprover/lean4-nightly
          match: "lean-4.0.0-nightly.*-linux.tar.zst$"

    - name: Unpack Lean4 build
      run: |
        file = $(echo lean-*.zst)
        mkdir lean4
        tar --use-compress-program=unzstd -xvf $file -C lean4 --strip-components 1
        ls -al lean4/bin
        echo ================= ldd lean
        ldd lean4/bin/lean
        echo ================= ldd libleanshared.so
        ldd lean4/lib/lean/libleanshared.so
        chmod u+x lean4/bin/*
    - name: Run lean --help
      run: ./lean4/bin/lean --help
    - name: Set paths
      run: |
        echo "$HOME/.elan/bin" >> $GITHUB_PATH
    - name: Setup elan toolchain on this build
      run: |
        curl -O --location https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh
        chmod u+x elan-init.sh
        ./elan-init.sh -y --default-toolchain none
        echo Checking location "$HOME/.elan/bin"...
        ls -al "$HOME/.elan/bin"
        elan toolchain link master "$(pwd)/lean4"
        elan default master
        echo master > lean-toolchain
    - name: Download mdbook for Lean
      run: |
        curl -O --location https://github.com/leanprover/mdBook/releases/download/v0.4.15l2/mdbook-linux.tar.gz
        tar xvf mdbook-linux.tar.gz
        ./mdbook-linux/mdbook --help
        ldd ./mdbook-linux/mdbook
    - name: Run mdbook test
      run: |
        ls -al
        ./mdbook-linux/mdbook test
